services:
  mariadb:
    image: mariadb:${MARIADB_VERSION}
    container_name: mariadb
    restart: unless-stopped
    ports:
      - "${MARIADB_PORT}:3306"
    environment:
      MARIADB_ROOT_PASSWORD: "${MARIADB_ROOT_PASSWORD}"
      MARIADB_DATABASE: "${MARIADB_DATABASE}"
      MARIADB_USER: "${MARIADB_USER}"
      MARIADB_PASSWORD: "${MARIADB_PASSWORD}"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./db:/docker-entrypoint-initdb.d

  mongodb:
    image: mongo:7
    container_name: mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: clientsdb
    volumes:
      - mongo_data:/data/db

  event-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.event-service
    container_name: event-service
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: "jdbc:mariadb://mariadb:3306/${MARIADB_DATABASE}"
      SPRING_DATASOURCE_USERNAME: "${MARIADB_USER}"
      SPRING_DATASOURCE_PASSWORD: "${MARIADB_PASSWORD}"
      IDM_HOST: "idm-service"
      IDM_PORT: "9090"
    depends_on:
      - mariadb
      - idm-service

  client-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.client-service
    container_name: client-service
    restart: unless-stopped
    ports:
      - "8082:8082"
    environment:
      SPRING_DATA_MONGODB_URI: "mongodb://mongodb:27017/clientsdb"
      CLIENT_EVENT_SERVICE_BASE_URL: "http://event-service:8080/api/event-manager"
      IDM_HOST: "idm-service"
      IDM_PORT: "9090"
    depends_on:
      - mongodb
      - event-service
      - idm-service

  idm-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.idm-service
    container_name: idm-service
    restart: unless-stopped
    ports:
      - "9090:9090"
    depends_on:
      - mariadb

volumes:
  mariadb_data:
  mongo_data:
